
<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Vietnam → Destinations (Label Toggle + Icon Size Control)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  html, body, #map { height: 100%; margin: 0; }
  .panel {
    position: absolute; top: 56px; right: 12px; width: 400px;
    max-height: calc(100% - 68px); overflow: auto;
    background: rgba(255,255,255,0.96); border-radius: 12px; 
    box-shadow: 0 8px 30px rgba(0,0,0,.12); padding: 12px;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    z-index: 1000; transition: transform .2s ease, opacity .2s ease;
  }
  .panel.hidden { transform: translateY(-8px); opacity: 0; pointer-events: none; }
  .panel h2 { margin: 4px 0 10px 0; font-size: 16px; }
  .row { display: grid; grid-template-columns: 1.1fr 1.9fr; gap: 6px; align-items: center; margin-bottom: 6px; }
  .row label { font-size: 12px; font-weight: 600; color: #333; }
  .row input[type="text"] { width: 100%; font-size: 12px; padding: 6px 8px; border: 1px solid #ddd; border-radius: 8px; }
  .btnbar { display: flex; gap: 8px; flex-wrap: wrap; margin: 8px 0; }
  button { padding: 8px 10px; border: 0; border-radius: 8px; background: #1e88e5; color: white; font-weight: 600; cursor: pointer; }
  button.secondary { background: #e0e0e0; color: #222; }
  .toggle {
    position: absolute; top: 12px; right: 12px; z-index: 1100;
    background: #1e88e5; color: #fff; border: 0; border-radius: 999px;
    padding: 10px 14px; font-weight: 700; cursor: pointer; box-shadow: 0 8px 30px rgba(0,0,0,.15);
  }
  .note { font-size: 12px; color: #555; line-height: 1.3; }
  .dest-label { color: #1e88e5; font-weight: 800; text-shadow: 0 1px 0 #fff, 0 -1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff; }
  .origin-label { color: #d32f2f; font-weight: 900; text-shadow: 0 1px 0 #fff, 0 -1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff; }
  .leaflet-tooltip { background: transparent; border: 0; box-shadow: none; }
  .flag-icon img {
  width: 28px; height: 28px;
  background: transparent !important;
  border-radius: 0 !important;
  box-shadow: none !important;
  outline: none !important;
  filter: none !important;
}
  /* Label toggle: khi body có .labels-off thì ẩn tất cả tooltip */
  body.labels-off .leaflet-tooltip { display: none !important; }
  /* Icon size control UI */
  .size-ctl { display:flex; align-items:center; gap:8px; }
  .size-ctl input[type="range"]{ flex:1; }
  .size-ctl .num{ width:42px; text-align:right; font-variant-numeric: tabular-nums; }
</style>
</head>
<body>
<div id="map"></div>
<button id="togglePanel" class="toggle">Hide list ▴</button>
<div class="panel" id="panel">
  <h2>Editable icons per country</h2>
  <div class="row size-ctl">
    <label>Kích thước Vietnam</label>
    <button id="minusBtnVN" class="secondary">−</button>
    <input id="sizeRangeVN" type="range" min="16" max="96" step="1" value="34"/>
    <button id="plusBtnVN" class="">+</button>
    <div class="num"><span id="sizeValVN">34</span>px</div>
<div class="row size-ctl">
    <label>Kích thước icon</label>
    <button id="minusBtn" class="secondary">−</button>
    <input id="sizeRange" type="range" min="16" max="72" step="1" value="28"/>
    <button id="plusBtn" class="">+</button>
    <div class="num"><span id="sizeVal">28</span>px</div>

  </div>
  </div>
  <div id="inputs"></div>
  <div class="btnbar">
    <button id="applyBtn">Apply changes</button>
    <button id="resetBtn" class="secondary">Reset</button>
    <button id="exportBtn" class="secondary">Export JSON</button>
    <button id="toggleLabelsBtn" class="secondary">Hide labels</button>
  </div>
  <div class="note">
    - Thanh trượt/± sẽ tăng giảm kích thước TẤT CẢ icon đồng bộ và tự căn lại vị trí label phía trên.<br/>
    - Thay đổi được lưu vào <b>localStorage</b> (mở lại vẫn giữ).
  </div>
  <textarea id="exportBox" style="width:100%;height:80px;margin-top:8px;display:none;"></textarea>
</div>

<script>
  const STORAGE_KEY = "iconConfig_vn_routes_v3";
  const LABELS_KEY = "labelsHidden_v1";
  const SIZE_KEY   = "iconSize_v1";
  const VN_SIZE_KEY = "iconSizeVN_v1";
  const lineColor = "#1e88e5";

  // Origin (Vietnam) with flag
  const origin = { name: "Vietnam", lat: 14.0583, lng: 108.2772, flag: "https://cdn-icons-png.flaticon.com/512/202/202939.png" };

  // Countries with flags
  const countries = [
    { name: "Australia", lat: -25.2744, lng: 133.7751, flag: "https://img.icons8.com/emoji/48/australia-emoji.png" },
    { name: "Belarus", lat: 53.7098, lng: 27.9534, flag: "https://img.icons8.com/emoji/48/belarus-emoji.png" },
    { name: "Brunei", lat: 4.5353, lng: 114.7277, flag: "https://img.icons8.com/emoji/48/brunei-emoji.png" },
    { name: "Cambodia", lat: 12.5657, lng: 104.9910, flag: "https://img.icons8.com/emoji/48/cambodia-emoji.png" },
    { name: "Canada", lat: 56.1304, lng: -106.3468, flag: "https://img.icons8.com/emoji/48/canada-emoji.png" },
    { name: "China", lat: 35.8617, lng: 104.1954, flag: "https://img.icons8.com/emoji/48/china-emoji.png" },
    { name: "Cuba", lat: 21.5218, lng: -77.7812, flag: "https://img.icons8.com/emoji/48/cuba-emoji.png" },
    { name: "Greece", lat: 39.0742, lng: 21.8243, flag: "https://img.icons8.com/emoji/48/greece-emoji.png" },
    { name: "Finland", lat: 61.9241, lng: 25.7482, flag: "https://img.icons8.com/emoji/48/finland-emoji.png" },
    { name: "France", lat: 46.2276, lng: 2.2137, flag: "https://img.icons8.com/emoji/48/france-emoji.png" },
    { name: "Germany", lat: 51.1657, lng: 10.4515, flag: "https://img.icons8.com/emoji/48/germany-emoji.png" },
    { name: "Hong Kong, China", lat: 22.3193, lng: 114.1694, flag: "https://img.icons8.com/emoji/48/hong-kong-sar-china-emoji.png" },
    { name: "Hungary", lat: 47.1625, lng: 19.5033, flag: "https://img.icons8.com/emoji/48/hungary-emoji.png" },
    { name: "India", lat: 20.5937, lng: 78.9629, flag: "https://img.icons8.com/emoji/48/india-emoji.png" },
    { name: "Indonesia", lat: -0.7893, lng: 113.9213, flag: "https://img.icons8.com/emoji/48/indonesia-emoji.png" },
    { name: "Iran", lat: 32.4279, lng: 53.6880, flag: "https://img.icons8.com/emoji/48/iran-emoji.png" },
    { name: "Japan", lat: 36.2048, lng: 138.2529, flag: "https://img.icons8.com/emoji/48/japan-emoji.png" },
    { name: "Kazakhstan", lat: 48.0196, lng: 66.9237, flag: "https://img.icons8.com/emoji/48/kazakhstan-emoji.png" },
    { name: "Laos", lat: 19.8563, lng: 102.4955, flag: "https://img.icons8.com/emoji/48/laos-emoji.png" },
    { name: "Luxembourg", lat: 49.8153, lng: 6.1296, flag: "https://img.icons8.com/emoji/48/luxembourg-emoji.png" },
    { name: "Malaysia", lat: 4.2105, lng: 101.9758, flag: "https://img.icons8.com/emoji/48/malaysia-emoji.png" },
    { name: "Mozambique", lat: -18.6657, lng: 35.5296, flag: "https://img.icons8.com/emoji/48/mozambique-emoji.png" },
    { name: "Myanmar", lat: 21.9162, lng: 95.9560, flag: "https://img.icons8.com/emoji/48/myanmar-burma-emoji.png" },
    { name: "Netherlands", lat: 52.1326, lng: 5.2913, flag: "https://img.icons8.com/emoji/48/netherlands-emoji.png" },
    { name: "DPRK", lat: 40.3399, lng: 127.5101, flag: "https://img.icons8.com/emoji/48/north-korea-emoji.png" },
    { name: "South Korea", lat: 35.9078, lng: 127.7669, flag: "https://img.icons8.com/emoji/48/south-korea-emoji.png" },
    { name: "Philippines", lat: 12.8797, lng: 121.7740, flag: "https://img.icons8.com/emoji/48/philippines-emoji.png" },
    { name: "Pakistan", lat: 30.3753, lng: 69.3451, flag: "https://img.icons8.com/emoji/48/pakistan-emoji.png" },
    { name: "Mongolia", lat: 46.8625, lng: 103.8467, flag: "https://img.icons8.com/emoji/48/mongolia-emoji.png" },
    { name: "Poland", lat: 51.9194, lng: 19.1451, flag: "https://img.icons8.com/emoji/48/poland-emoji.png" },
    { name: "Qatar", lat: 25.3548, lng: 51.1839, flag: "https://img.icons8.com/emoji/48/qatar-emoji.png" },
    { name: "Russia", lat: 61.5240, lng: 105.3188, flag: "https://img.icons8.com/emoji/48/russia-emoji.png" },
    { name: "Singapore", lat: 1.3521, lng: 103.8198, flag: "https://img.icons8.com/emoji/48/singapore-emoji.png" },
    { name: "Sweden", lat: 60.1282, lng: 18.6435, flag: "https://img.icons8.com/emoji/48/sweden-emoji.png" },
    { name: "Switzerland", lat: 46.8182, lng: 8.2275, flag: "https://img.icons8.com/emoji/48/switzerland-emoji.png" },
    { name: "Taipei, China", lat: 23.6978, lng: 120.9605, flag: "https://img.icons8.com/emoji/48/taiwan-emoji.png" },
    { name: "Thailand", lat: 15.8700, lng: 100.9925, flag: "https://img.icons8.com/emoji/48/thailand-emoji.png" },
    { name: "United Arab Emirates", lat: 23.4241, lng: 53.8478, flag: "https://img.icons8.com/emoji/48/united-arab-emirates-emoji.png" },
    { name: "United Kingdom", lat: 55.3781, lng: -3.4360, flag: "https://img.icons8.com/emoji/48/united-kingdom-emoji.png" },
    { name: "Ukraine",        lat: 48.3794, lng: 31.1656, flag: "https://img.icons8.com/emoji/48/ukraine-emoji.png" },
    { name: "United States",  lat: 37.0902, lng: -95.7129, flag: "https://img.icons8.com/emoji/48/united-states-emoji.png" },
  ];

  // Load configs
  let iconConfig = {}; iconConfig[origin.name] = origin.flag; countries.forEach(c => iconConfig[c.name] = c.flag);
  const savedCfg = localStorage.getItem(STORAGE_KEY); if(savedCfg){ try{ Object.assign(iconConfig, JSON.parse(savedCfg)); }catch(e){} }
  let ICON_SIZE = parseInt(localStorage.getItem(SIZE_KEY) || "28", 10);
  let VN_SIZE = parseInt(localStorage.getItem(VN_SIZE_KEY) || String(Math.max(ICON_SIZE, 32)), 10);

  // Map
  const map = L.map('map', {
  zoomControl: true,
  zoomSnap: 0.25,   // allow fractional zoom levels (¼ steps)
  zoomDelta: 0.25,  // +/- buttons & keyboard zoom by 0.25
  wheelPxPerZoomLevel: 120 // optional: smoother mouse-wheel zoom
});
  L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png',
    { attribution: '&copy; OpenStreetMap & CARTO', maxZoom: 19 }).addTo(map);

  // Create a dedicated top pane for Vietnam marker so it always stacks above others
  map.createPane('vnPane');
  map.getPane('vnPane').style.zIndex = 700; // markerPane default is 600

  // Helpers
  function makeDivIcon(url, size = ICON_SIZE) {
    const safe = (url || '').replace(/"/g, '&quot;');
    const html = `<img style="width:${size}px;height:${size}px" src="${safe}" onerror="this.onerror=null; this.src='https://cdn0.iconfinder.com/data/icons/basic-14/614/43_-_Iocation-1024.png';" />`;
    return L.divIcon({ html, className: 'flag-icon', iconSize: [size, size], iconAnchor: [size/2, size] });
  }

  const markers = {};
  const bounds = L.latLngBounds([ [origin.lat, origin.lng] ]);

  // Origin
  const originMarker = L.marker([origin.lat, origin.lng], { icon: makeDivIcon(iconConfig[origin.name], VN_SIZE), pane: 'vnPane', zIndexOffset: 10000 }).addTo(map);

  // Create a dedicated top pane for Vietnam marker so it always stacks above others
  map.createPane('vnPane');
  map.getPane('vnPane').style.zIndex = 700; // markerPane default is 600
  originMarker.bindTooltip(origin.name, { permanent:true, direction:'bottom', offset:[0, VN_SIZE], className:'origin-label' }).openTooltip();

  // Curve
  function bezier(a, b, lift=0.16, steps=100) {
    const mlat=(a[0]+b[0])/2, mlng=(a[1]+b[1])/2;
    const dx=b[1]-a[1], dy=b[0]-a[0];
    const len=Math.sqrt(dx*dx+dy*dy)+1e-9;
    const nx=-dy/len, ny=dx/len;
    const k=lift*len, clat=mlat+ny*k, clng=mlng+nx*k;
    const pts=[];
    for(let i=0;i<=steps;i++){
      const t=i/steps;
      const lat=(1-t)*(1-t)*a[0] + 2*(1-t)*t*clat + t*t*b[0];
      const lng=(1-t)*(1-t)*a[1] + 2*(1-t)*t*clng + t*t*b[1];
      pts.push([lat,lng]);
    }
    return pts;
  }

  // Countries + lines
  countries.forEach(c => {
    const m = L.marker([c.lat, c.lng], { icon: makeDivIcon(iconConfig[c.name]) }).addTo(map);

  // Create a dedicated top pane for Vietnam marker so it always stacks above others
  map.createPane('vnPane');
  map.getPane('vnPane').style.zIndex = 700; // markerPane default is 600
    m.bindTooltip(c.name, { permanent:true, direction:'bottom', offset:[0, ICON_SIZE], className:'dest-label' }).openTooltip();
    markers[c.name] = m; bounds.extend([c.lat, c.lng]);
    const pts = bezier([origin.lat, origin.lng], [c.lat, c.lng], 0.16, 120);
    L.polyline(pts, { color: "#1e88e5", weight: 2.3, opacity: 0.95, dashArray: "8,10" }).addTo(map);

  // Create a dedicated top pane for Vietnam marker so it always stacks above others
  map.createPane('vnPane');
  map.getPane('vnPane').style.zIndex = 700; // markerPane default is 600
  });
  map.fitBounds(bounds.pad(0.08));

  // Panel toggle
  const PANEL_KEY = "panelCollapsed_v3";
  const panel = document.getElementById('panel'); const toggleBtn = document.getElementById('togglePanel');
  function setPanelState(collapsed) {
    if (collapsed) { panel.classList.add('hidden'); toggleBtn.textContent = "Show list ▾"; }
    else { panel.classList.remove('hidden'); toggleBtn.textContent = "Hide list ▴"; }
    localStorage.setItem(PANEL_KEY, collapsed ? "1" : "0");
  }
  setPanelState(localStorage.getItem(PANEL_KEY) === "1");
  toggleBtn.addEventListener('click', () => setPanelState(!panel.classList.contains('hidden')));

  // Inputs for icons
  const inputsDiv = document.getElementById('inputs');
  function renderInputs() {
    inputsDiv.innerHTML = '';
    const vnRow = document.createElement('div'); vnRow.className='row';
    vnRow.innerHTML = `<label>${origin.name}</label><input type="text" id="input-${origin.name.replace(/\s+/g,'_')}" value="${iconConfig[origin.name]}"/>`;
    inputsDiv.appendChild(vnRow);
    countries.forEach(c => {
      const row = document.createElement('div'); row.className='row';
      row.innerHTML = `<label>${c.name}</label><input type="text" id="input-${c.name.replace(/\s+/g,'_')}" value="${iconConfig[c.name]}"/>`;
      inputsDiv.appendChild(row);
    });
  }
  renderInputs();

  function applyChanges(){
    // VN
    let id = 'input-' + origin.name.replace(/\s+/g,'_');
    let val = document.getElementById(id).value.trim() || origin.flag;
    iconConfig[origin.name] = val;
    originMarker.setIcon(makeDivIcon(val, VN_SIZE));
    originMarker.unbindTooltip(); originMarker.bindTooltip(origin.name, { permanent:true, direction:'bottom', offset:[0, VN_SIZE], className:'origin-label' }).openTooltip();
    // Countries
    countries.forEach(c => {
      const id = 'input-' + c.name.replace(/\s+/g,'_');
      const val = document.getElementById(id).value.trim() || c.flag;
      iconConfig[c.name] = val;
      const mk = markers[c.name];
      mk.setIcon(makeDivIcon(val, ICON_SIZE));
      mk.unbindTooltip(); mk.bindTooltip(c.name, { permanent:true, direction:'bottom', offset:[0, ICON_SIZE], className:'dest-label' }).openTooltip();
    });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(iconConfig));
  }

  function resetConfig(){
    iconConfig = {}; iconConfig[origin.name] = origin.flag; countries.forEach(c => iconConfig[c.name] = c.flag);
    renderInputs(); applyChanges();
  }

  document.getElementById('applyBtn').onclick = applyChanges;
  document.getElementById('resetBtn').onclick = resetConfig;
  document.getElementById('exportBtn').onclick = () => {
    const box = document.getElementById('exportBox'); box.style.display='block';
    box.value = JSON.stringify(iconConfig, null, 2); box.select();
  };

  // Label toggle
  const toggleLabelsBtn = document.getElementById('toggleLabelsBtn');
  function setLabelsHidden(hidden) {
    document.body.classList.toggle('labels-off', hidden);
    toggleLabelsBtn.textContent = hidden ? 'Show labels' : 'Hide labels';
    localStorage.setItem(LABELS_KEY, hidden ? '1' : '0');
  }
  setLabelsHidden(localStorage.getItem(LABELS_KEY) === '1');
  toggleLabelsBtn.addEventListener('click', () => setLabelsHidden(!document.body.classList.contains('labels-off')));

  // ----- ICON SIZE CONTROL (global, synced) -----
  const sizeRange = document.getElementById('sizeRange');
  const sizeVal   = document.getElementById('sizeVal');
  const minusBtn  = document.getElementById('minusBtn');
  const plusBtn   = document.getElementById('plusBtn');

  // init from saved
  sizeRange.value = String(ICON_SIZE);
  sizeVal.textContent = String(ICON_SIZE);

  function applyIconSize(size){
    ICON_SIZE = Math.max(16, Math.min(72, Math.round(size)));
    sizeRange.value = String(ICON_SIZE);
    sizeVal.textContent = String(ICON_SIZE);
    localStorage.setItem(SIZE_KEY, String(ICON_SIZE));
    // Rebuild all icons & relocate labels (offset = -ICON_SIZE)
    originMarker.setIcon(makeDivIcon(iconConfig[origin.name], VN_SIZE));
    originMarker.unbindTooltip(); originMarker.bindTooltip(origin.name, { permanent:true, direction:'bottom', offset:[0, VN_SIZE], className:'origin-label' }).openTooltip();
    countries.forEach(c => {
      const mk = markers[c.name];
      mk.setIcon(makeDivIcon(iconConfig[c.name], ICON_SIZE));
      mk.unbindTooltip(); mk.bindTooltip(c.name, { permanent:true, direction:'bottom', offset:[0, ICON_SIZE], className:'dest-label' }).openTooltip();
    });
  }

  sizeRange.addEventListener('input', e => applyIconSize(parseInt(e.target.value,10)));
  minusBtn.addEventListener('click', () => applyIconSize(ICON_SIZE - 2));
  plusBtn.addEventListener('click',  () => applyIconSize(ICON_SIZE + 2));


  // ----- VIETNAM ICON SIZE CONTROL (independent) -----
  const sizeRangeVN = document.getElementById('sizeRangeVN');
  const sizeValVN   = document.getElementById('sizeValVN');
  const minusBtnVN  = document.getElementById('minusBtnVN');
  const plusBtnVN   = document.getElementById('plusBtnVN');

  // init from saved
  sizeRangeVN.value = String(VN_SIZE);
  sizeValVN.textContent = String(VN_SIZE);

  function applyVNIconSize(size){
    VN_SIZE = Math.max(16, Math.min(96, Math.round(size)));
    sizeRangeVN.value = String(VN_SIZE);
    sizeValVN.textContent = String(VN_SIZE);
    localStorage.setItem(VN_SIZE_KEY, String(VN_SIZE));
    originMarker.setIcon(makeDivIcon(iconConfig[origin.name], VN_SIZE));
    originMarker.unbindTooltip(); originMarker.bindTooltip(origin.name, { permanent:true, direction:'bottom', offset:[0, VN_SIZE], className:'origin-label' }).openTooltip();
  }

  sizeRangeVN.addEventListener('input', e => applyVNIconSize(parseInt(e.target.value,10)));
  minusBtnVN.addEventListener('click', () => applyVNIconSize(VN_SIZE - 2));
  plusBtnVN.addEventListener('click',  () => applyVNIconSize(VN_SIZE + 2));


</script>
</body>
</html>
